---
title: "STAT_380_Final_Code"
author: "Andrew Bartnikowski, Zachary Brown, Julian Grossman, Rowan Tolfree"
date: "2025-11-26"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Front Matter - Clean Environment, Load Libraries, Read dataset

```{r}
rm(list = ls())
library(readr)
library(tidyr)
library(dplyr)
library(stringr)
library(ggplot2)
library(forcats)
library(FNN)
```

Load in our data sets
```{r}
Modes <- read.csv("CODGameModes.csv")
Player1_raw <- read.csv("CODGames_p1_380.csv")
Player2_raw <- read.csv("CODGames_p2_380.csv")
```
## Google Slides Link
https://docs.google.com/presentation/d/1PNZlMqMhsrZjMR_51fbR-UHyPgB0tzKvTeELMKPCPP8/edit?usp=sharing 

## Task 1 -- Exploratory Analysis

Remove hardcore indicators in a separate column to prepare the data for a join on the COD game modes data. I kept the data for each player seperate foe ease of use when trying to compare insights from each. A joint data set will be made soon below.
```{r}
Player1 <- Player1_raw  %>%
  mutate(Mode = str_replace(GameType, "HC - ", ""))

Player2 <- Player2_raw  %>%
  mutate(Mode = str_replace(GameType, "HC - ", ""))
```

Join each players data with the game modes data so we can answer our research question, "Which game mode is most likely to reach the score limit?".
```{r}
Clean_p1 <- Player1 %>%
  left_join(Modes, by = c("Mode" = "Mode"))

Clean_p2 <- Player2 %>%
  left_join(Modes, by = c("Mode" = "Mode"))
```


Need to be able to identify whether or not score limit has been reached
```{r}
Clean_p1 <- Clean_p1 %>% 
  filter(Score != is.na(Score))%>% 
  separate(Result, into = c("PlayerTeam", "OtherTeam"), sep = "-", convert = TRUE) %>% 
  mutate(MaxScore = pmax(PlayerTeam, OtherTeam),
         ScoreLimitReached = MaxScore == ScoreLimit) 

Clean_p2 <- Clean_p2 %>% 
  filter(Score != is.na(Score)) %>% 
  separate(Result, into = c("PlayerTeam", "OtherTeam"), sep = "-", convert = TRUE) %>% 
  mutate(MaxScore = pmax(PlayerTeam, OtherTeam),
         ScoreLimitReached = MaxScore == ScoreLimit) 
```


Joined the players to make one large data set to more accurately answer our research question for task 1.
```{r}
Joined_players <- bind_rows(Clean_p1, Clean_p2)
```

Create visualization displaying the game modes and the proportion of them reaching the score limit. Simple bar chart to explain this.
```{r}
ggplot(
  data = Joined_players %>%
    group_by(Mode) %>%
    summarise(
      Pct_limit = mean(ScoreLimitReached)
      ),
  mapping = aes(x = Mode, y = Pct_limit)
) + 
  labs(
  title = "Percent of Games per Mode Where Score Limit was Reached",
  x = "Game Mode",
  y = "Percentage of Games Score Limit Reached"
) +
  geom_col(width = 0.5, fill = "lightblue") +
  theme_bw()
```

## Task 2 -- Inference

### Task 2a - Which predictors are associated with the TotalXP?

#### Convert categorical Variables
```{r}
Joined_players2 <- Joined_players %>%
  # Convert categorical variables to factors
  mutate(
    GameType = as.factor(GameType),
    Mode = as.factor(Mode),
    PrimaryWeapon = as.factor(PrimaryWeapon),
    XPType = as.factor(XPType),
    FullPartial = as.factor(FullPartial),
    DidPlayerVote = as.factor(DidPlayerVote),
    ScoreLimitReached = as.factor(ScoreLimitReached)
  )
```

There are two different Double XP + 10%. 517 for one and one for the other. So we will merge those 2 as this is most likely a mistake when imputing the data.
```{r}
Joined_players2 <- Joined_players2 %>%
  mutate(
    XPType = fct_collapse(XPType,
                          "Double XP + 10%" = c("Double XP + 10%", "Double XP + 10% "))
  )
```

#### Find Rows With NA
```{r}
col_NA_totals <- colSums(is.na(Joined_players2))
col_NA_totals
```

#### Multiple Linear Regression
```{r}
lm_xp <- lm(
  TotalXP ~ Eliminations + Deaths + Score + Damage +
            Mode + PrimaryWeapon + XPType +
            FullPartial + DidPlayerVote + ScoreLimitReached,
  data = Joined_players2
)

coef_df <- as.data.frame(summary(lm_xp)$coefficients)

coef_df_p05 <- coef_df %>%
  filter(`Pr(>|t|)`<.05)%>%
  arrange(`Pr(>|t|)`) %>%
  select(Estimate,`Pr(>|t|)`)

coef_df_p1 <- coef_df %>%
  filter(`Pr(>|t|)`<.1) %>%
  arrange(`Pr(>|t|)`) %>%
  select(Estimate,`Pr(>|t|)`)
summary(lm_xp)
```

Due to the large number of missing values in the variables Confirms, Denies, Objectives, ObjectiveKills, Captures, Diffuses, Plants, Detonates, Deposits, Time_Sec, and Time_Min, these variables were excluded from the model to avoid loss of data. After running the multiple linear regression, then looking at the p-values denoted by the Pr(>|t|) column, it tells us which predictors are statistically significant predictors for TotalXP. The predictors that will be deemed statistically significant will have a p-value less than 0.05. The predictors that fit this are: Eliminations, Score, Damage, PrimaryWeaponMilano 821, PrimaryWeaponXM4, and XPTypeDouble XP + 10%. These results indicate that TotalXP is primarily driven by player performance metrics and XP multipliers.

```{r}
coef_df_p1
```
#### Testing Different variables in a  single variable linear regression
Looking at the associated P Values associated with the proper t value, it can be seen that the most strongly correlated variable for predicting TotalXP was if a player had Double XP or not. The next two strongest correlated variables were score and Eliminations. We next decided to see what the RMSE would be when we used each of these as a predictor.

```{r}
lm_xpType <- lm(TotalXP ~ XPType, data = Joined_players2)
lm_score <- lm(TotalXP ~ Score, data = Joined_players2)
lm_elims <- lm(TotalXP ~ Eliminations, data = Joined_players2)
lm_t3 <- lm(TotalXP ~ XPType + Eliminations+ Score, data = Joined_players2)

results <- as.data.frame(
  rbind(
    c("XPType",        sqrt(mean(residuals(lm_xpType)^2)), summary(lm_xpType)$r.squared),
    c("Score",         sqrt(mean(residuals(lm_score)^2)),  summary(lm_score)$r.squared),
    c("Eliminations",  sqrt(mean(residuals(lm_elims)^2)),  summary(lm_elims)$r.squared),
    c("Top 3 Vars",    sqrt(mean(residuals(lm_t3)^2)),     summary(lm_t3)$r.squared)
  )
)
colnames(results) <- c("Model", "RMSE", "Multiple R-squared")
results
summary(lm_t3)


```
The XPType variable represents, similar to the intercept, if a value of 7747.5164 should be added to TotalXP having an x value of 1 if a game did have Double XP and 0 if it did not, holding all other variables constant. The eliminations variable represents the increase to TotalXP for each elimination a player earned during a game, holding all other variables constant. The score variable represents the increase in TotalXP for each unit of score earned, holding all other variables constant.

```{r}
ggplot(Joined_players2, aes(x = Eliminations, y = TotalXP)) +
  geom_point(alpha = 0.4, color = "blue") +
  geom_smooth(method = "lm", se = TRUE, color = "red") +
  labs(
    title = "Regression Line: TotalXP ~ Eliminations",
    x = "Eliminations",
    y = "Total XP"
  ) +
  theme_minimal(base_size = 14)
```
```{r}
Joined_players2$pred_t3 <- predict(lm_t3)

ggplot(Joined_players2, aes(x = pred_t3, y = TotalXP)) +
  geom_point(alpha = 0.4, color = "blue") +
  geom_smooth(method = "lm", color = "red") +
  labs(
    title = "Predicted vs Actual TotalXP (Top 3 Model)",
    x = "Predicted TotalXP",
    y = "Actual TotalXP"
  ) +
  theme_minimal(base_size = 14)

```

### Task 2b -Of the predictors associated with the response, select one of the predictors and explain the relationship between the predictor and TotalXP.
```{r}
ggplot(Joined_players2, aes(x = XPType, y = TotalXP)) +
  geom_boxplot(fill = "lightblue") +
  labs(
    title = "Effect of XPType on TotalXP",
    x = "XPType",
    y = "TotalXP"
  )
```

The boxplot clearly shows that matches with Double XP result in much higher TotalXP than standard matches. This confirms the model result that XPType is a strong driver of XP gains.

## Task 3 Prediction
### Research Question: What are the best predictors for classifying game mode?

#### Take only columns that are not game mode unique or we are not interested in. Also selection of only matches the player played fully.
```{r}

Task3_base <- Joined_players2 %>%
  filter(Choice!='')%>%
  filter(FullPartial!='Partial')%>%
  select(
    -any_of(c(
      "Confirms", "Denies", "Objectives", "ObjectiveKills",
      "Captures", "Diffuses", "Plants", "Detonates",
      "Deposits", "Time_Sec", "Time_Min","Map1", "Map2","MapVote",
      "GameType", "Date", "ScoreLimit", "TimeLimit", "MaxScore"
    ))
  ) 
```

#### Perform one-hot encoding and rejoin with numeric values
```{r}
X_task3 <- as.data.frame(model.matrix(
  Mode ~ Choice + PrimaryWeapon + XPType + DidPlayerVote  + ScoreLimitReached ,
  data = Task3_base
)[, -1])

numeric_df <- Task3_base %>%
  select(PlayerTeam,OtherTeam,Eliminations,Deaths,Score,Damage,TotalXP)

X_task3 <- cbind(X_task3,numeric_df)
```

#### Split data into testing and training sets
```{r}
set.seed(123)
n_obs <- nrow(X_task3)
train_idx <- sample(seq_len(n_obs), size = floor(0.7 * n_obs))
test_idx  <- setdiff(seq_len(n_obs), train_idx)

X_train <- X_task3[train_idx, ]
X_test  <- X_task3[test_idx, ]
y_train <- Task3_base$Mode[train_idx]
y_test  <- Task3_base$Mode[test_idx]

```


#### Not Needed
If wanted we could add this to the numeric_df to scale it, those vals are scaleable. 
```{r eval=FALSE}
X_train_sc <- scale(X_train)
X_test_sc  <- scale(
  X_test,
  center = attr(X_train_sc, "scaled:center"),
  scale  = attr(X_train_sc, "scaled:scale")
)
```

### Classification Method 1: KNN
```{r}

k_values_knn <- 1:20
knn_results <- data.frame(
k = k_values_knn,
accuracy = rep(NA, length(k_values_knn))
)

for (i in seq_along(k_values_knn)) {
  k_now <- k_values_knn[i]
  knn_fit <- knn(
    train = X_train,
    test  = X_test,
    cl    = y_train,
    k     = k_now
    )
  knn_results$accuracy[i] <- mean(as.character(knn_fit) == as.character(y_test))

}

knn_results

```

### Classification Method 2: Random Forests
```{r}

```

### Classification Method 3: ----
```{r}

``` 

